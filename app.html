<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoVerse - AI Audiobook Creator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #e3f2fd;
            --container-bg: #ffffff;
            --text-color: #1a237e;
            --sub-text-color: #3f51b5;
            --primary-light: #64b5f6;
            --primary-dark: #2196f3;
            --accent-color: #1e88e5;
            --border-color: #bbdefb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
        }
        .container {
            max-width: 1000px;
            background-color: var(--container-bg);
        }
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom modal styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .text-box {
            min-height: 200px;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: var(--container-bg);
            line-height: 1.6;
            color: var(--text-color);
        }
        
        .title-text {
            color: var(--text-color);
        }
        .subtitle-text {
            color: var(--sub-text-color);
        }
        .input-label {
            color: var(--text-color);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div id="app-container" class="container bg-white rounded-3xl shadow-xl p-8 md:p-12 w-full fade-in">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold title-text tracking-tight mb-2">EchoVerse</h1>
            <p class="text-xl md:text-2xl subtitle-text font-medium">Your AI-Powered Audiobook Studio</p>
        </header>

        <!-- Input Section -->
        <div class="space-y-6 mb-8">
            <div class="flex flex-col md:flex-row md:space-x-6 space-y-4 md:space-y-0">
                <div class="flex-1">
                    <label for="inputText" class="block input-label font-semibold mb-2">
                        Enter your text or upload a .txt file
                    </label>
                    <textarea id="inputText" class="w-full h-40 md:h-48 p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300" placeholder="Paste or type your story here..."></textarea>
                </div>
                <div class="flex-1 flex flex-col justify-end">
                    <input type="file" id="fileInput" accept=".txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4 cursor-pointer">
                    <label for="voiceSelect" class="block input-label font-semibold mb-2">Select a voice</label>
                    <select id="voiceSelect" class="w-full p-3 border border-gray-300 rounded-xl appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <option value="Kore">Kore</option>
                        <option value="Zephyr">Zephyr</option>
                        <option value="Puck">Puck</option>
                        <option value="Fenrir">Fenrir</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center">
            <button id="generateBtn" class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold text-lg rounded-xl shadow-lg hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500">
                Generate Audiobook
            </button>
        </div>

        <!-- Output Section (Hidden by default) -->
        <div id="outputSection" class="mt-10 hidden fade-in">
            <!-- Text Comparison -->
            <div class="flex flex-col md:flex-row md:space-x-6 space-y-6 md:space-y-0 mb-8">
                <div class="flex-1">
                    <h2 class="text-xl font-bold title-text mb-2">Original Text</h2>
                    <div id="originalText" class="text-box"></div>
                </div>
                <div class="flex-1">
                    <h2 class="text-xl font-bold title-text mb-2">Rewritten Text</h2>
                    <div id="rewrittenText" class="text-box"></div>
                </div>
            </div>

            <!-- Audio Output -->
            <h2 class="text-2xl font-bold title-text mb-4 text-center">Your Audiobook</h2>
            <div id="audioOutput" class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-md">
                <audio controls class="w-full">
                    <source src="" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
            </div>
            <div class="text-center mt-6">
                <a id="downloadBtn" href="#" download="echoverse_audio.wav" class="inline-block px-6 py-3 bg-white text-gray-700 font-semibold rounded-xl border border-gray-300 shadow-sm hover:bg-gray-100 transform hover:scale-105 transition duration-300">
                    Download Audiobook
                </a>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl flex items-center space-x-4 modal-content">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loadingText" class="text-gray-800 text-lg font-medium">Generating your audiobook...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 z-50 flex items-center justify-center bg-red-900 bg-opacity-75 hidden modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl space-y-4 text-center modal-content">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3.042L13.732 4.96a2 2 0 00-3.464 0L3.34 16.958c-.77 1.375.19 3.042 1.732 3.042z" />
            </svg>
            <h3 class="text-2xl font-bold text-red-700">Oops!</h3>
            <p id="errorMessage" class="text-gray-600">Something went wrong. Please try again.</p>
            <button id="closeErrorModal" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-300">Close</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const generateBtn = document.getElementById('generateBtn');
            const inputText = document.getElementById('inputText');
            const fileInput = document.getElementById('fileInput');
            const voiceSelect = document.getElementById('voiceSelect');
            const outputSection = document.getElementById('outputSection');
            const originalTextDiv = document.getElementById('originalText');
            const rewrittenTextDiv = document.getElementById('rewrittenText');
            const audioPlayer = document.querySelector('#audioOutput audio');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingModal = document.getElementById('loadingModal');
            const loadingText = document.getElementById('loadingText');
            const errorModal = document.getElementById('errorModal');
            const errorMessage = document.getElementById('errorMessage');
            const closeErrorModal = document.getElementById('closeErrorModal');

            // --- EchoVerse Application Features ---
            // 1) Tone-Adaptive Text Rewriting: Rewrites text into Neutral, Suspenseful, or Inspiring tones.
            //    Uses Gemini 2.5 Flash LLM for prompt-chained text transformation.
            // 2) High-Quality Voice Narration: Converts rewritten text into natural-sounding audio.
            //    Now uses IBM Watson Text-to-Speech with selectable voices.
            // 3) Downloadable and Streamable Audio Output: Allows users to listen to audio in-app
            //    and download the final narration as a .wav file for offline use.
            // 4) Side-by-Side Text Comparison: Displays original and tone-adapted text for easy
            //    verification and stylistic comparison.
            // 5) User-Friendly Interface: Provides a responsive, intuitive interface built with
            //    Tailwind CSS for accessibility and ease of use.
            // ------------------------------------

            // API endpoint and parameters for LLM
            const llmModelName = "gemini-2.5-flash-preview-05-20";
            const llmApiKey = "";
            const llmApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${llmModelName}:generateContent?key=${llmApiKey}`;
            
            // Gemini TTS API credentials and endpoint
            const ttsModelName = "gemini-2.5-flash-preview-tts";
            const ttsApiKey = "";
            const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${ttsModelName}:generateContent?key=${ttsApiKey}`

            // Helper function to show modals
            const showModal = (modalElement, text = null) => {
                if (text) {
                    loadingText.textContent = text;
                }
                modalElement.classList.remove('hidden');
            };

            // Helper function to hide modals
            const hideModal = (modalElement) => {
                modalElement.classList.add('hidden');
            };

            // Helper function to convert base64 to ArrayBuffer
            const base64ToArrayBuffer = (base64) => {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            };

            // Helper function to convert raw PCM audio data into a WAV file blob
            const pcmToWav = (pcmData, sampleRate) => {
                const pcm16 = new Int16Array(pcmData);
                const dataLength = pcm16.length * 2;
                const buffer = new ArrayBuffer(44 + dataLength);
                const view = new DataView(buffer);

                const writeString = (view, offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };

                // RIFF chunk descriptor
                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataLength, true);
                writeString(view, 8, 'WAVE');

                // FMT sub-chunk
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true); // Audio format (1 = PCM)
                view.setUint16(22, 1, true); // Number of channels
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true); // Byte rate
                view.setUint16(32, 2, true); // Block align
                view.setUint16(34, 16, true); // Bits per sample

                // Data sub-chunk
                writeString(view, 36, 'data');
                view.setUint32(40, dataLength, true);

                // Write the PCM data
                let offset = 44;
                for (let i = 0; i < pcm16.length; i++) {
                    view.setInt16(offset, pcm16[i], true);
                    offset += 2;
                }

                return new Blob([view], { type: 'audio/wav' });
            };

            const rewriteText = async (text, tone) => {
                const prompt = `Rewrite the following text in a ${tone} tone. Keep the original meaning and facts, but enhance the expressiveness and style to match the tone. The length should be roughly the same.
                
Original text: "${text}"
                
Rewritten text:`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                const response = await fetch(llmApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `LLM error! Status: ${response.status}`);

                }

                const result = await response.json();
                const rewrittenText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rewrittenText) {
                    throw new Error("No rewritten text received from the API.");
                }
                return rewrittenText;
            };

            const generateAudiobook = async () => {
                let originalText = inputText.value.trim();
                const voice = voiceSelect.value;
                const file = fileInput.files[0];
                const MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024; // 20 MB

                if (file) {
                    if (file.size > MAX_FILE_SIZE_BYTES) {
                        errorMessage.textContent = "The file you uploaded is too large. Please select a file smaller than 20MB.";
                        showModal(errorModal);
                        return;
                    }
                    originalText = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => resolve(event.target.result);
                        reader.onerror = (error) => reject(error);
                        reader.readAsText(file);
                    });
                }
                
                if (!originalText) {
                    errorMessage.textContent = "Please enter some text or upload a file to generate an audiobook.";
                    showModal(errorModal);
                    return;
                }

                showModal(loadingModal, "Rewriting text with AI...");

                try {
                    const rewrittenText = await rewriteText(originalText, voiceSelect.options[voiceSelect.selectedIndex].text);
                    originalTextDiv.textContent = originalText;
                    rewrittenTextDiv.textContent = rewrittenText;
                    
                    showModal(loadingModal, "Generating high-quality audio with Gemini...");

                    const payload = {
                        contents: [
  {
    parts: [
      {
        text: `Narrate the following text: "${rewrittenText}"`
      }
    ]
  }
],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: voice }
                                }
                            }
                        },
                    };

                    const ttsResponse = await fetch(ttsApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!ttsResponse.ok) {
                        const errorData = await ttsResponse.json();
                        throw new Error(errorData.error.message || `Gemini TTS API Error: ${ttsResponse.status}`);

                    }

                    const ttsResult = await ttsResponse.json();
                    const audioPart = ttsResult?.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                    
                    if (!audioPart || !audioPart.data || !audioPart.mimeType) {
                        throw new Error("No audio data received from the Gemini TTS API.");
                    }
                    
                    const audioData = base64ToArrayBuffer(audioPart.data);
                    const sampleRate = parseInt(audioPart.mimeType.split('rate=')[1], 10);
                    const audioBlob = pcmToWav(audioData, sampleRate);
                    const audioUrl = URL.createObjectURL(audioBlob);

                    audioPlayer.src = audioUrl;
                    outputSection.classList.remove('hidden');
                    downloadBtn.href = audioUrl;
                    downloadBtn.download = `echoverse_audio_${voice}.wav`;
                    
                } catch (error) {
                    console.error("Generation failed:", error);
                   downloadBtn.download = `echoverse_audio_${voice}.wav`;
                    showModal(errorModal);
                } finally {
                    hideModal(loadingModal);
                }
            };

            generateBtn.addEventListener('click', generateAudiobook);
            closeErrorModal.addEventListener('click', () => hideModal(errorModal));
        });
    </script>

</body>
</html>
